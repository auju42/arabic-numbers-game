<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© â€” Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;900&display=swap" rel="stylesheet">

<style>
/* ---------- Visual theme ---------- */
:root{
  --bg1: #fff7f9;
  --bg2: #fffbf9;
  --accent: #d32f2f;
  --muted: #6b6b6b;
  --card:#ffffff;
  --glass: rgba(255,255,255,0.65);
  --correct:#dff0dc;
  --wrong:#ffe7e7;
  --shadow: 0 12px 30px rgba(15,15,15,0.06);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: "Tajawal", "Noto Kufi Arabic", Tahoma, Arial, sans-serif;
  background: linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 100%);
  color:#222;
  direction:rtl;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  padding:18px;
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:100vh;
}

/* container */
.app{
  width:100%;
  max-width:980px;
  margin:0 auto;
}

/* header */
.header{
  display:flex;
  gap:12px;
  align-items:center;
  justify-content:space-between;
  margin-bottom:18px;
}
.brand{ display:flex; gap:12px; align-items:center; }
.logo{ width:64px; height:64px; border-radius:14px; background: linear-gradient(135deg,#ff6b6b,#ffb86b); display:grid; place-items:center; color:white; font-weight:900; box-shadow: 0 8px 28px rgba(0,0,0,0.08); font-size:24px; }
.title{ font-size:20px; line-height:1; font-weight:900; }
.subtitle{ font-size:12px; color:var(--muted); }

/* card */
.card{ background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9)); border-radius:16px; padding:18px; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.03); }

/* center layout */
.center{ display:grid; gap:14px; align-items:center; justify-items:center; }

/* first screen (name) */
#nameScreen{ max-width:620px; margin: 4px auto; text-align:center; }
.input{ width:100%; display:flex; gap:8px; align-items:center; justify-content:center; margin-top:12px; }
.input input{ flex:1; padding:12px 14px; border-radius:12px; border:1px solid #eee; font-size:16px; outline:none; box-shadow: inset 0 1px 0 rgba(0,0,0,0.02); }
.btn{ display:inline-flex; align-items:center; gap:10px; padding:12px 18px; border-radius:12px; border:none; background:linear-gradient(90deg,var(--accent), #ff7043); color:white; font-weight:800; cursor:pointer; box-shadow: 0 8px 20px rgba(211,47,47,0.18); transition:transform .15s ease, box-shadow .15s ease; }
.btn:active{ transform:translateY(2px) scale(.996); }
.btn.secondary{ background:transparent; color:var(--accent); border:2px solid rgba(211,47,47,0.12); box-shadow:none; }

/* mode screen (only three big buttons) */
.mode-grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:14px; width:100%; margin-top:8px; }
.mode-card{ background:linear-gradient(180deg,#fff,#fff); border-radius:14px; padding:18px; text-align:center; box-shadow: 0 8px 24px rgba(0,0,0,0.05); cursor:pointer; transition:transform .12s ease, box-shadow .12s ease; border:1px solid rgba(0,0,0,0.03); }
.mode-card:hover{ transform:translateY(-6px); box-shadow: 0 26px 50px rgba(0,0,0,0.08); }
.mode-emoji{ font-size:32px; margin-bottom:8px; display:block; }
.mode-title{ font-weight:900; font-size:18px; margin-bottom:6px;}
.mode-desc{ font-size:13px; color:var(--muted) }

/* game area */
#gameArea{ display:none; margin-top:12px; }
.topbar{ display:flex; gap:12px; align-items:center; justify-content:space-between; width:100%; flex-wrap:wrap;}
.info-pill{ background:var(--glass); padding:8px 12px; border-radius:999px; border:1px solid rgba(0,0,0,0.03); display:inline-flex; gap:8px; align-items:center; font-weight:800; font-size:14px; }
.big-btn{ padding:10px 14px; border-radius:12px; border:2px solid rgba(0,0,0,0.06); background:white; cursor:pointer; }

/* progress circle */
.progress-wrap { display:flex; align-items:center; gap:12px; margin-top:14px; justify-content:center; }
.timer-circle { width:78px; height:78px; }
.timer-label { font-weight:900; font-size:14px; color:var(--muted); }

/* options */
#options{ display:flex; flex-wrap:wrap; gap:14px; justify-content:center; margin-top:18px; }
.option{ min-width:160px; padding:18px 22px; border-radius:14px; text-align:center; font-size:22px; background:linear-gradient(180deg,#fff,#fff); border:1px solid rgba(0,0,0,0.04); cursor:pointer; box-shadow: 0 12px 30px rgba(0,0,0,0.03); transition:transform .14s cubic-bezier(.2,.9,.2,1), box-shadow .14s, opacity .25s; user-select:none;}
.option:hover{ transform:translateY(-6px) scale(1.02); box-shadow: 0 26px 60px rgba(0,0,0,0.06); }
.option:active{ transform:translateY(2px) scale(.99); }

/* feedback states */
.option.correct { background: linear-gradient(180deg, #f0fff4, var(--correct)); border-color:#66bb6a; box-shadow: 0 14px 36px rgba(102,187,106,0.12); transform: scale(1.04); }
.option.wrong { background: linear-gradient(180deg, #fff5f5, var(--wrong)); border-color: #e57373; box-shadow: 0 12px 30px rgba(229,115,115,0.10); transform: scale(.98); }
.option.disabled { pointer-events:none; opacity:.6; }

/* fade away after click */
.option.fading { animation: fadeAndScale 400ms ease forwards; }
@keyframes fadeAndScale { to { opacity:0; transform:scale(.88) translateY(-6px); } }

/* shake for wrong */
@keyframes shake {
  10%{ transform:translateX(6px); }
  30%{ transform:translateX(-6px); }
  50%{ transform:translateX(4px); }
  70%{ transform:translateX(-2px); }
  100%{ transform:translateX(0); }
}
.option.shake { animation: shake 420ms cubic-bezier(.36,.07,.19,.97); }

/* streak */
.streak { font-weight:900; color: #2e7d32; font-size:16px; padding:6px 10px; border-radius:10px; background:linear-gradient(180deg,#f7fff7,#f0fff4); border:1px solid rgba(46,125,50,0.06); }

/* confetti */
.confetti-piece {
  position:fixed; width:10px; height:16px; z-index:9999; pointer-events:none;
  transform-origin:center;
  animation: conf-fall linear forwards;
}
@keyframes conf-fall {
  to { transform: translateY(110vh) rotate(720deg); opacity:0.05; }
}

/* end screen */
#endScreen{ margin-top:18px; text-align:center; display:none; }

/* leaderboards */
#leaderboards{ display:none; gap:12px; margin-top:18px; justify-content:center; align-items:flex-start; }
.board{ min-width:240px; padding:16px; background:linear-gradient(180deg,#fff,#fff); border-radius:12px; box-shadow:0 8px 28px rgba(0,0,0,0.04); border:1px solid rgba(0,0,0,0.03) }

/* small */
.small{ font-size:13px; color:var(--muted) }

/* responsive tweaks */
@media (max-width:820px){
  .mode-grid{ grid-template-columns:repeat(1,1fr) }
  .header{ flex-direction:column; align-items:flex-start; gap:8px }
  .option{ min-width:140px; font-size:18px; padding:14px 18px; }
}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="brand">
      <div class="logo">Ø£</div>
      <div>
        <div class="title">Ù„Ø¹Ø¨Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</div>
        <div class="subtitle">Ø®Ù…Ù† Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø³Ù…ÙˆØ¹ â€” Ø³Ù‡Ù„ ÙˆØ³Ø±ÙŠØ¹</div>
      </div>
    </div>
    <div class="small">ÙŠØ­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¹Ø¨Ø± Firebase (Ø¥Ù† ÙƒØ§Ù† Ù…ÙØ¹Ù„Ù‹Ø§) â€¢ Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØª Ù…Ù† Google Cloud TTS Ø£Ùˆ mp3</div>
  </div>

  <div class="card center" id="nameScreen">
    <div style="width:100%;text-align:center">
      <h2>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„Ù„Ø¨Ø¯Ø¡</h2>
      <p class="small">Ø§Ù„Ø§Ø³Ù… Ø³ÙŠÙØ­ÙØ¸ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</p>
    </div>
    <div class="input" style="width:100%;max-width:520px">
      <input id="playerName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§" />
      <button id="saveName" class="btn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</button>
    </div>
    <div class="small" style="margin-top:6px">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†" Ø«Ù… Ø§Ø®ØªØ± ÙˆØ¶Ø¹ Ø§Ù„Ù„Ø¹Ø¨Ø©</div>
  </div>

  <!-- second screen -->
  <div class="card center" id="modeScreen" style="display:none; margin-top:16px; text-align:center; max-width:760px;">
    <h2>Ø§Ø®ØªØ± Ø§Ù„ÙˆØ¶Ø¹</h2>
    <p class="small">Ø³Ù‡Ù„ (1â€“10 Â· 3 Ø®ÙŠØ§Ø±Ø§Øª) Ø£Ùˆ ØµØ¹Ø¨ (1â€“100 Â· 5 Ø®ÙŠØ§Ø±Ø§Øª)</p>
    <div class="mode-grid" style="width:100%;margin-top:12px;">
      <div class="mode-card" id="modeEasy" role="button" tabindex="0"><span class="mode-emoji">ğŸ™‚</span><div class="mode-title">Ø³Ù‡Ù„</div><div class="mode-desc">Ø£Ø±Ù‚Ø§Ù… 1â€“10 Â· 3 Ø®ÙŠØ§Ø±Ø§Øª</div></div>
      <div class="mode-card" id="modeHard" role="button" tabindex="0"><span class="mode-emoji">ğŸ”¥</span><div class="mode-title">ØµØ¹Ø¨</div><div class="mode-desc">Ø£Ø±Ù‚Ø§Ù… 1â€“100 Â· 5 Ø®ÙŠØ§Ø±Ø§Øª</div></div>
      <div class="mode-card" id="viewBoards" role="button" tabindex="0"><span class="mode-emoji">ğŸ†</span><div class="mode-title">Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</div><div class="mode-desc">Ø§Ø·Ù„Ø¹ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</div></div>
    </div>
  </div>

  <!-- game area -->
  <div class="card" id="gameArea" style="margin-top:16px;">
    <div class="topbar">
      <div class="info-pill">Ø§Ù„Ù„Ø§Ø¹Ø¨: <strong id="pname" style="margin-inline:6px"></strong></div>
      <div class="info-pill"><span class="timer-area" style="display:flex;align-items:center;gap:10px;">
        <div class="progress-wrap">
          <svg class="timer-circle" viewBox="0 0 100 100" aria-hidden="true">
            <defs>
              <linearGradient id="g1" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#ff7043"/><stop offset="100%" stop-color="#d32f2f"/></linearGradient>
            </defs>
            <circle cx="50" cy="50" r="42" stroke="#f0f0f0" stroke-width="12" fill="none"></circle>
            <circle id="timerStroke" cx="50" cy="50" r="42" stroke="url(#g1)" stroke-width="12" stroke-linecap="round" fill="none" transform="rotate(-90 50 50)" stroke-dasharray="263.89" stroke-dashoffset="0"></circle>
          </svg>
          <div class="timer-label" id="timeLeftWrap" style="position:relative;right:6px; top:-56px; text-align:center;">
            <div style="font-weight:900" id="timeLeft">60</div>
            <div class="small">Ø«Ø§Ù†ÙŠØ©</div>
          </div>
        </div>
      </span></div>
      <div class="info-pill">Ø§Ù„Ù†ØªÙŠØ¬Ø©: <strong id="scoreVal" style="margin-inline:6px">0</strong></div>
      <div class="info-pill streak" id="streakDisp">Ø³Ù„Ø³Ù„Ø©: <strong id="streakVal">0</strong></div>
      <div><button id="playNumberBtn" class="big-btn">ğŸ”Š Ø¥Ø¹Ø§Ø¯Ø© Ø³Ù…Ø§Ø¹</button></div>
    </div>

    <div id="options" aria-live="polite"></div>

    <div id="endScreen">
      <h3>Ø§Ù†ØªÙ‡Øª Ø§Ù„ÙˆÙ‚Øª!</h3>
      <p class="small">Ù†ØªÙŠØ¬ØªÙƒ: <strong id="finalScore"></strong></p>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:10px">
        <button id="saveScoreBtn" class="btn">Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
        <button id="playAgainBtn" class="btn secondary">Ø§Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
      </div>
    </div>

    <div id="leaderboards" style="display:none; margin-top:18px; justify-content:center; gap:12px;">
      <div style="width:100%;display:flex;justify-content:flex-end;gap:8px;margin-bottom:6px">
        <button id="backToModes" class="btn secondary">â† Ø±Ø¬ÙˆØ¹</button>
      </div>
      <div class="board"><h4>Ù„ÙˆØ­Ø© (Ø³Ù‡Ù„)</h4><ol id="boardEasy"></ol></div>
      <div class="board"><h4>Ù„ÙˆØ­Ø© (ØµØ¹Ø¨)</h4><ol id="boardHard"></ol></div>
    </div>
  </div>
</div>

<!-- confetti container -->
<div id="confettiRoot"></div>

<!-- ========== FIREBASE SDK (paste before your main game script) ========== -->
<script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = {
  apiKey: "AIzaSyDy8cu2oLdmJhvMb_i2bioc9G5ZwM5oJH8",
  authDomain: "arabic-numbers.firebaseapp.com",
  databaseURL: "https://arabic-numbers-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "arabic-numbers",
  storageBucket: "arabic-numbers.firebasestorage.app",
  messagingSenderId: "426562157033",
  appId: "1:426562157033:web:bc4c7ac019e43e9fb7b378"
  };

  if (Object.keys(firebaseConfig).length !== 0) {
    try { firebase.initializeApp(firebaseConfig); var db = firebase.database(); console.log('Firebase initialized'); } catch(e){ console.warn('Firebase init error', e); var db = null; }
  } else { console.warn('Firebase config empty'); var db = null; }
</script>

<!-- ========== MAIN GAME SCRIPT ========== -->
<script>
/* ---------------- Config ---------------- */
const GAME_LENGTH = 60;
const EASY_MAX = 10;
const HARD_MAX = 100;
const EASY_OPTIONS = 3;
const HARD_OPTIONS = 5;
const INITIAL_DELAY_MS = 1200; // used as baseline; will be adjusted by speed tiers
const MIN_DELAY_MS = 350;
const ASSET_PATH = 'assets/numbers/'; // mp3 files: assets/numbers/1.mp3 ...
const SPEED_TIERS = [
  {needed: 0, disappear: 1200, audioRate: 1.0, delay: 1200},
  {needed: 3, disappear: 900, audioRate: 1.15, delay: 900},
  {needed: 6, disappear: 650, audioRate: 1.3, delay: 650},
  {needed: 9, disappear: 480, audioRate: 1.45, delay: 480}
];

/* ---------------- UI refs ---------------- */
const nameScreen = document.getElementById('nameScreen');
const modeScreen = document.getElementById('modeScreen');
const gameArea = document.getElementById('gameArea');

const playerNameInput = document.getElementById('playerName');
const saveNameBtn = document.getElementById('saveName');
const modeEasy = document.getElementById('modeEasy');
const modeHard = document.getElementById('modeHard');
const viewBoards = document.getElementById('viewBoards');

const pnameSpan = document.getElementById('pname');
const playNumberBtn = document.getElementById('playNumberBtn');
const timeLeftSpan = document.getElementById('timeLeft');
const scoreValSpan = document.getElementById('scoreVal');
const optionsDiv = document.getElementById('options');

const timerStroke = document.getElementById('timerStroke');
const timeLeftWrap = document.getElementById('timeLeft');

const endScreen = document.getElementById('endScreen');
const finalScoreSpan = document.getElementById('finalScore');
const saveScoreBtn = document.getElementById('saveScoreBtn');
const playAgainBtn = document.getElementById('playAgainBtn');

const leaderboardsDiv = document.getElementById('leaderboards');
const boardEasy = document.getElementById('boardEasy');
const boardHard = document.getElementById('boardHard');
const backToModesBtn = document.getElementById('backToModes');

const streakDisp = document.getElementById('streakVal');
const confettiRoot = document.getElementById('confettiRoot');

/* ---------------- state ---------------- */
let playerName = localStorage.getItem('playerName') || '';
let currentMode = null;
let timeLeft = GAME_LENGTH;
let score = 0;
let currentNumber = null;
let timerInterval = null;
let roundTimeout = null;
let roundAnswered = false; // prevents multiple clicks awarding multiple points
let streak = 0;
let correctTotal = 0; // overall correct answers this run (used for speed tiers)
let currentTier = 0; // 0..3

/* ---------------- audio helpers ---------------- */
function beep(freq, duration=120){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine";
    o.frequency.value = freq;
    o.connect(g);
    g.connect(ctx.destination);
    o.start();
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.18, ctx.currentTime + 0.01);
    setTimeout(()=> {
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.01);
      o.stop(ctx.currentTime + 0.02);
      ctx.close();
    }, duration);
  }catch(e){}
}

function speakArabicWords(text, rate=1.0){
  if (!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'ar-SA';
  u.rate = Math.max(0.6, Math.min(2.0, rate));
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}

/* number->words (keeps from original file) */
function numberToArabicWords(n){
  const ones = ["","ÙˆØ§Ø­Ø¯","Ø§Ø«Ù†Ø§Ù†","Ø«Ù„Ø§Ø«Ø©","Ø£Ø±Ø¨Ø¹Ø©","Ø®Ù…Ø³Ø©","Ø³ØªØ©","Ø³Ø¨Ø¹Ø©","Ø«Ù…Ø§Ù†ÙŠØ©","ØªØ³Ø¹Ø©","Ø¹Ø´Ø±Ø©","Ø£Ø­Ø¯ Ø¹Ø´Ø±","Ø§Ø«Ù†Ø§ Ø¹Ø´Ø±","Ø«Ù„Ø§Ø«Ø© Ø¹Ø´Ø±","Ø£Ø±Ø¨Ø¹Ø© Ø¹Ø´Ø±","Ø®Ù…Ø³Ø© Ø¹Ø´Ø±","Ø³ØªØ© Ø¹Ø´Ø±","Ø³Ø¨Ø¹Ø© Ø¹Ø´Ø±","Ø«Ù…Ø§Ù†ÙŠØ© Ø¹Ø´Ø±","ØªØ³Ø¹Ø© Ø¹Ø´Ø±","Ø¹Ø´Ø±ÙˆÙ†"];
  const tens = ["","", "Ø¹Ø´Ø±ÙˆÙ†","Ø«Ù„Ø§Ø«ÙˆÙ†","Ø£Ø±Ø¨Ø¹ÙˆÙ†","Ø®Ù…Ø³ÙˆÙ†","Ø³ØªÙˆÙ†","Ø³Ø¨Ø¹ÙˆÙ†","Ø«Ù…Ø§Ù†ÙˆÙ†","ØªØ³Ø¹ÙˆÙ†"];
  if (n < 20) return ones[n];
  if (n < 100){ const t = Math.floor(n/10); const o = n % 10; if (o === 0) return tens[t]; return `${ones[o]} Ùˆ ${tens[t]}`; }
  if (n === 100) return "Ù…Ø¦Ø©";
  return String(n);
}

function toArabicIndic(n){
  const map = ['Ù ','Ù¡','Ù¢','Ù£','Ù¤','Ù¥','Ù¦','Ù§','Ù¨','Ù©'];
  return String(n).split('').map(d => map[+d] || d).join('');
}

/* ---------------- Init flow ---------------- */
if (playerName) { showModeScreen(); } else { nameScreen.style.display = 'block'; modeScreen.style.display = 'none'; gameArea.style.display = 'none'; }

saveNameBtn.addEventListener('click', ()=> {
  const v = playerNameInput.value.trim();
  if (!v) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…');
  playerName = v;
  localStorage.setItem('playerName', playerName);
  showModeScreen();
});

function showModeScreen(){
  nameScreen.style.display = 'none';
  modeScreen.style.display = 'block';
  gameArea.style.display = 'none';
  pnameSpan.textContent = playerName;
}

/* Mode buttons */
modeEasy.addEventListener('click', ()=> startGame('easy'));
modeHard.addEventListener('click', ()=> startGame('hard'));
viewBoards.addEventListener('click', ()=> {
  nameScreen.style.display = 'none';
  modeScreen.style.display = 'none';
  gameArea.style.display = 'block';
  leaderboardsDiv.style.display = 'flex';
  endScreen.style.display = 'none';
  if (db) loadFirebaseBoards(); else loadLocalBoards();
});
backToModesBtn.addEventListener('click', ()=> {
  leaderboardsDiv.style.display = 'none';
  modeScreen.style.display = 'block';
});

/* replay audio */
playNumberBtn.addEventListener('click', ()=> {
  if (currentNumber) playNumberAudio(currentNumber);
});

/* end screen buttons */
playAgainBtn.addEventListener('click', ()=> {
  endScreen.style.display = 'none';
  startGame(currentMode);
});
saveScoreBtn.addEventListener('click', ()=> {
  if (db) saveScoreFirebase(); else saveScoreLocal();
});

/* ---------------- Game logic ---------------- */
function startGame(mode){
  currentMode = mode;
  score = 0;
  timeLeft = GAME_LENGTH;
  clearInterval(timerInterval);
  clearTimeout(roundTimeout);
  roundAnswered = false;
  streak = 0;
  correctTotal = 0;
  currentTier = 0;
  updateScore();
  updateStreak();
  timeLeftWrap.innerText = timeLeft;
  endScreen.style.display = 'none';
  leaderboardsDiv.style.display = 'none';
  optionsDiv.innerHTML = '';
  nameScreen.style.display = 'none';
  modeScreen.style.display = 'none';
  gameArea.style.display = 'block';
  startTimer();
  nextRound();
}

function startTimer(){
  clearInterval(timerInterval);
  // set initial circle
  updateTimerCircle();
  timerInterval = setInterval(()=> {
    timeLeft--;
    timeLeftWrap.innerText = timeLeft;
    updateTimerCircle();
    if (timeLeft <= 0){
      clearInterval(timerInterval);
      finishGame();
    }
  }, 1000);
}

function updateTimerCircle(){
  const circumference = 2 * Math.PI * 42; // r=42
  const percent = Math.max(0, timeLeft / GAME_LENGTH);
  const offset = circumference * (1 - percent);
  timerStroke.style.strokeDashoffset = offset;
  // update color slightly based on percent â€” optional
}

function finishGame(){
  clearTimeout(roundTimeout);
  // set final score
  finalScoreSpan.textContent = score;

  // hide game interactive elements so only score + leaderboards show
  optionsDiv.style.display = 'none';
  // hide the endScreen buttons (we'll still show the simple final score text)
  saveScoreBtn.style.display = 'none';
  playAgainBtn.style.display = 'none';

  // show the minimal end text (keeps the finalScoreSpan visible)
  endScreen.style.display = 'block';

  // auto-save result (firebase if available else local) and then show leaderboards
  if (db) {
    saveScoreFirebase(true /*silent*/).finally(()=> {
      if (db) loadFirebaseBoards();
      leaderboardsDiv.style.display = 'flex';
    });
  } else {
    saveScoreLocal(true /*silent*/);
    loadLocalBoards();
    leaderboardsDiv.style.display = 'flex';
  }

  // ensure the page scrolls to leaderboards in small screens
  setTimeout(()=> {
    leaderboardsDiv.scrollIntoView({behavior:'smooth', block:'center'});
  }, 150);
}

/* speed-tier helpers */
function computeCurrentTier(){
  // sets currentTier based on correctTotal
  let tier = 0;
  for (let i = SPEED_TIERS.length -1; i>=0; i--){
    if (correctTotal >= SPEED_TIERS[i].needed) { tier = i; break; }
  }
  currentTier = tier;
  return SPEED_TIERS[tier];
}

/* ---------------- Round flow ---------------- */
async function nextRound(){
  if (timeLeft <= 0) return;
  roundAnswered = false;
  const tier = computeCurrentTier();
  const maxNum = (currentMode === 'easy') ? EASY_MAX : HARD_MAX;
  const optionsCount = (currentMode === 'easy') ? EASY_OPTIONS : HARD_OPTIONS;
  currentNumber = randInt(1, maxNum);
  const answers = buildOptions(currentNumber, optionsCount, maxNum);
  renderOptions(answers, tier);
  try { await playNumberAudio(currentNumber, tier.audioRate); } catch(e){ try { speakArabicWords(numberToArabicWords(currentNumber), tier.audioRate); } catch(e){} }
}

function renderOptions(arr, tier){
  optionsDiv.innerHTML = '';
  arr.forEach(n => {
    const b = document.createElement('button');
    b.className = 'option';
    b.innerText = toArabicIndic(n);
    b.dataset.val = n;
    b.addEventListener('click', ()=> handleChoice(n, b, tier));
    optionsDiv.appendChild(b);
  });
}

function handleChoice(chosen, btnEl, tier){
  if (timeLeft <= 0) return;
  if (roundAnswered) return; // prevent multi-click score
  roundAnswered = true;

  // disable all options for this round
  const allButtons = Array.from(optionsDiv.querySelectorAll('.option'));
  allButtons.forEach(x => { x.classList.add('disabled'); });

  if (chosen === currentNumber){
    // correct
    score++;
    correctTotal++;
    streak++;
    updateScore();
    updateStreak();
    beep(880, 120);
    btnEl.classList.add('correct');
    // confetti celebration
    spawnConfetti();
    // fade out clicked option at speed based on tier
    const disappearMs = Math.max(150, tier.disappear);
    btnEl.style.transition = `opacity ${disappearMs}ms ease, transform ${disappearMs}ms ease`;
    btnEl.classList.add('fading');
    // schedule next round using tier delay (faster as tier increases)
    clearTimeout(roundTimeout);
    roundTimeout = setTimeout(()=> nextRound(), Math.max(MIN_DELAY_MS, tier.delay));
  } else {
    // wrong
    beep(220, 220);
    btnEl.classList.add('wrong','shake');
    streak = 0;
    updateStreak();
    // show correct answer visually
    const allButtons = Array.from(optionsDiv.querySelectorAll('.option'));
    const correctBtn = allButtons.find(x => Number(x.dataset.val) === Number(currentNumber));
    if (correctBtn) {
      correctBtn.classList.add('correct');
    }
    // fade wrong and mark correct; then continue after small delay
    clearTimeout(roundTimeout);
    roundTimeout = setTimeout(()=> nextRound(), Math.max(MIN_DELAY_MS, tier.delay + 300));
  }

  // after click, speed up TTS audio for next rounds will be handled by computeCurrentTier when correctTotal changes
}

/* ---------------- helpers ---------------- */
function updateScore(){ scoreValSpan.textContent = score; }
function updateStreak(){ streakDisp.textContent = streak; }

function buildOptions(correct, count, max){
  const s = new Set([correct]);
  while (s.size < count){
    let r = randInt(1, max);
    if (Math.random() < 0.5) r = Math.min(max, Math.max(1, correct + randInt(-3,3)));
    s.add(r);
  }
  const arr = Array.from(s);
  for (let i = arr.length -1; i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

/* ---------------- Playing number audio: mp3 if present, else TTS ---------------- */
async function playNumberAudio(num, rate=1.0){
  const audioPath = ASSET_PATH + num + '.mp3';
  // Try to fetch the file (works when served via http(s))
  try {
    const res = await fetch(audioPath, {method:'HEAD'});
    if (res.ok) {
      const a = new Audio(audioPath);
      a.playbackRate = rate || 1.0;
      await a.play().catch(()=>{}); // ignore play errors
      return;
    } else {
      // fallback to TTS
      speakArabicWords(numberToArabicWords(num), rate);
      return;
    }
  } catch (e) {
    // some environments block fetch; try loading audio directly
    try {
      const a = new Audio(audioPath);
      a.playbackRate = rate || 1.0;
      await a.play().catch(()=> {});
      return;
    } catch (_) {
      // fallback TTS
      speakArabicWords(numberToArabicWords(num), rate);
      return;
    }
  }
}

/* ---------------- Confetti ---------------- */
function spawnConfetti(){
  const COUNT = 28;
  for (let i=0;i<COUNT;i++){
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    el.style.left = (20 + Math.random()*60) + 'vw';
    el.style.top = (-10 - Math.random()*30) + 'vh';
    el.style.width = (8 + Math.random()*8) + 'px';
    el.style.height = (10 + Math.random()*10) + 'px';
    el.style.background = randomColor();
    el.style.opacity = 0.98;
    const duration = 1500 + Math.random()*1000;
    el.style.animationDuration = duration + 'ms';
    el.style.transform = `rotate(${Math.random()*360}deg)`;
    confettiRoot.appendChild(el);
    // remove after animation
    setTimeout(()=> {
      el.remove();
    }, duration + 300);
  }
}
function randomColor(){
  const set = ['#ff7043','#ffd54f','#66bb6a','#29b6f6','#ab47bc','#ff8a65'];
  return set[Math.floor(Math.random()*set.length)];
}

/* ---------------- Firebase leaderboard functions ---------------- */
function saveScoreFirebase(silent=false){
  if (!playerName) { if (!silent) alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…'); return Promise.resolve(); }
  const path = (currentMode === 'easy') ? 'leaderboard/easy' : 'leaderboard/hard';
  const entry = { name: playerName, score: score, time: Date.now() };
  if (!db) { if (!silent) alert('Firebase ØºÙŠØ± Ù…ØªØ§Ø­'); return Promise.resolve(); }
  return db.ref(path).push(entry).then(()=> {
    if (!silent) alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©!');
    if (!silent) loadFirebaseBoards();
  }).catch(err => { console.error(err); if (!silent) alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸'); });
}

function loadFirebaseBoards() {
  if (!db) return loadLocalBoards();

  const fetchLimit = 200; // grab enough records
  const refEasy = db.ref('leaderboard/easy').orderByChild('score').limitToLast(fetchLimit);
  const refHard = db.ref('leaderboard/hard').orderByChild('score').limitToLast(fetchLimit);

  refEasy.once('value', snap => {
    const arr = [];
    snap.forEach(child => {
      const val = child.val();
      if (val && val.name && typeof val.score !== 'undefined') {
        arr.push(val);
      }
    });
    arr.sort((a,b) => b.score - a.score); // highest first
    const top20 = arr.slice(0, 20);

    if (top20.length > 0) {
      boardEasy.innerHTML = top20.map(e => 
        `<li>${escapeHtml(e.name)} â€“ ${e.score}</li>`
      ).join('');
    } else {
      boardEasy.innerHTML = '<li class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯</li>';
    }
  });

  refHard.once('value', snap => {
    const arr = [];
    snap.forEach(child => {
      const val = child.val();
      if (val && val.name && typeof val.score !== 'undefined') {
        arr.push(val);
      }
    });
    arr.sort((a,b) => b.score - a.score);
    const top20 = arr.slice(0, 20);

    if (top20.length > 0) {
      boardHard.innerHTML = top20.map(e => 
        `<li>${escapeHtml(e.name)} â€“ ${e.score}</li>`
      ).join('');
    } else {
      boardHard.innerHTML = '<li class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯</li>';
    }
  });
}

/* ---------------- Local leaderboard (fallback) ---------------- */
function saveScoreLocal(silent=false){
  if (!playerName) { if (!silent) alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…'); return; }
  const key = (currentMode === 'easy') ? 'board_easy' : 'board_hard';
  const list = JSON.parse(localStorage.getItem(key) || '[]');
  list.push({name: playerName, score: score, time: Date.now()});
  list.sort((a,b)=> b.score - a.score || a.time - b.time);
  localStorage.setItem(key, JSON.stringify(list.slice(0,20)));
  if (!silent) alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§!');
  loadLocalBoards();
}

function loadLocalBoards(){
  const easy = JSON.parse(localStorage.getItem('board_easy') || '[]');
  const hard = JSON.parse(localStorage.getItem('board_hard') || '[]');
  boardEasy.innerHTML = easy.length ? easy.map(e=>`<li>${escapeHtml(e.name)} â€” ${e.score}</li>`).join('') : '<li class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯</li>';
  boardHard.innerHTML = hard.length ? hard.map(e=>`<li>${escapeHtml(e.name)} â€” ${e.score}</li>`).join('') : '<li class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯</li>';
  leaderboardsDiv.style.display = 'flex';
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ---------------- When page loads: try to load firebase boards if available else local ---------------- */
if (db) {
  loadFirebaseBoards();
} else {
  loadLocalBoards();
}
</script>
</body>
</html>
